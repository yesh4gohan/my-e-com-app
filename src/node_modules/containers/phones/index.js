import React, { Component } from 'react'
import PropTypes from 'prop-types'
import { connect } from 'react-redux'
import {fetchPhones,loadMorePhones,addToCart,setLoader} from "actions";
import {getPhones} from "selectors";
import {Link} from "react-router";
import Loader from "react-loader";
import cookie from 'react-cookies';


export class Phones extends Component {

  constructor(){
    super();
    this.state = {
      phones : []
    };
  }
  async componentDidMount(){
      this.props.setLoader(true);
      await this.props.fetchPhones();
      this.setState({phones:this.props.phones});
      this.props.setLoader(false);
  }
  componentWillReceiveProps(nextProps){
    this.setState({phones:nextProps.phones});
  }
   addToCart = async id => {
    this.props.setLoader(true);
    await this.props.addToCart(id);
    this.props.setLoader(false);
  }
  renderPhones = (phone,index) => {
    const shortDescription = `${phone.description.substr(0,40)} ...`;
    return (
      <div className='col-sm-4 col-lg-4 col-md-4 book-list' key={index}>
        <div className='thumbnail'>
          <img
            className='img-thumbnail'
            src={phone.image}
            alt={phone.name}
          />
          <div className='caption'>
            <h4 className='pull-right'>${phone.price}</h4>
            <h4>
              <Link to={`/phone/${phone.id}`}>
                {phone.name}
              </Link>
            </h4>
            <p>{shortDescription}</p>
            <p className='itemButton'>
              <button
                className='btn btn-primary'
                onClick = {() => {this.addToCart(phone.productId)}}
              >
                Buy Now!
              </button>
              <Link 
                to={`/phone/${phone.productId}`}
                className='btn btn-default'
              >
                More info
              </Link>
            </p>
          </div>
        </div>
      </div>
    )
  }
  render() {
      const {loadMorePhones} = this.props;
      const {phones} = this.state;
      console.log(cookie)
    return (
      <Loader loaded = {!this.props.loading.loading} className="spinner">
      <div className = "books row">
        {phones.map((phone,index) =>this.renderPhones(phone,index))}
      </div>
      <div className = "col-md-12">
        <button
        className = "pull-right btn btn-primary"
        onClick = {()=>{loadMorePhones(phones.length)}}
        >
        Load More
        </button>
      </div>
      </Loader>
    )
  
  }
}

const mapStateToProps = (state) => ({
  phones: getPhones(state),
  loading: state.loading
})

const mapDispatchToProps = {
  fetchPhones,
  loadMorePhones,
  addToCart,
  setLoader
}

export default connect(mapStateToProps, mapDispatchToProps)(Phones)
